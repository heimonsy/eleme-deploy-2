{% extends 'layout.master' %}
{% block main %}
    <div class="row">
        <div class="col-lg-12">
            <h2>{{ site.name }}</h2>
            <br>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->

    <div class="row">
        <div class="col-lg-12">
            <!-- Nav tabs -->
            <ul id="myTab" class="nav nav-tabs" role="tablist">
                <li role="presentation"><a href="#Setting" role="tab" data-toggle="tab">项目配置</a></li>
                <li role="presentation"><a href="#DeploySetting" role="tab" data-toggle="tab">发布配置</a></li>
                <li role="presentation"><a href="#HostType" role="tab" data-toggle="tab">机器分组</a></li>
                <li role="presentation"><a href="#Hosts" role="tab" data-toggle="tab">机器配置</a></li>
                <li role="presentation"><a href="#Build" role="tab" data-toggle="tab">Build</a></li>
                <li role="presentation"><a href="#Deploy" role="tab" data-toggle="tab">Deploy</a></li>
                <li role="presentation"><a href="#PrBuild" role="tab" data-toggle="tab">PR Build</a></li>
                <li role="presentation"><a href="#PrDeploy" role="tab" data-toggle="tab">PR Deploy</a></li>
            </ul>
            <br>

            <!-- Tab panes -->
            <div id="myTabContent" class="tab-content">
                <div role="tabpanel" class="tab-pane" id="Setting"></div>
                <div role="tabpanel" class="tab-pane" id="DeploySetting"></div>
                <div role="tabpanel" class="tab-pane" id="HostType">
                    <div class="row">
                        <div class="col-lg-12"><button class="btn btn-primary" id="newHostType">新增</button></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <table id="hostTypeTable" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>HostType</th>
                                        <th>环境</th>
                                        <th>修改</th>
                                        <th>删除</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="Hosts">
                    <div class="row">
                        <div class="col-lg-12"><button class="btn btn-primary" id="newHost">新增</button></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <table id="hostsTable" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>机器名</th>
                                        <th>IP</th>
                                        <th>SSH 端口</th>
                                        <th>发布类型</th>
                                        <th>机器分组</th>
                                        <th>修改</th>
                                        <th>删除</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="Build">
                    <div class="row">
                        <div class="col-lg-12" id="buildFormWrapper">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <table id="buildTable" class="table table-bordered table-hover small-table">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Checkout</th>
                                        <th>Commit</th>
                                        <th>状态</th>
                                        <th>状态消息</th>
                                        <th max-width="150">更新时间</th>
                                        <th max-width="80">详细</th>
                                        <th>发布</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="Deploy">Deploy</div>
                <div role="tabpanel" class="tab-pane" id="PrBuild">Pr Build</div>
                <div role="tabpanel" class="tab-pane" id="PrDeploy">Pr Deploy</div>
                <div role="tabpanel" class="tab-pane" id="JobInfo"></div>
            </div>
        </div>
    </div>
{% endblock main %}
{% block footer_js %}
<script>
var siteId = {{ site.id }};
var defaultBranch = '{{ site.default_branch }}';
var csrfToken = '{{ csrf_token() }}';
var timeoutEvent = null;
var refreshInterval = null;
var prevJobId = null;

$(function () {
    $('#myTab a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    });

    var showJobInfo = function (jobId) {
        prevJobId = jobId;
        $("#myTab").append('<li role="presentation"><a href="#JobInfo-' + prevJobId + '" data-job-id="' + prevJobId + '" role="tab" data-toggle="tab">Job #' + prevJobId + '</a></li>');
        $("#myTabContent").append('<div role="tabpanel" class="tab-pane" id="JobInfo-' + prevJobId + '"></div>');
        initBtn();
        $('#myTab a:last').tab('show');
    };

    var initJobBtn = function () {
        $('.btnOpenJob').click(function (data) {
            var btn = $(this);
            btn.button('loading');
            showJobInfo(btn.attr('data-job-id'));
            btn.button('reset');
        });
    };

    var showBuilds = function () {
        var table = null;
        return function () {
            if (table == null) {
                table = $("#buildTable").DataTable({
                    ajax: '/api/site/' + siteId + '/build',
                    paging: false,
                    ordering: false,
                    info: false,
                    columns: [
                        {data: 'job_id'},
                        {data: 'checkout'},
                        {data: 'commit'},
                        {data: 'status'},
                        {data: 'status_info'},
                        {data: 'updated_at'},
                        {data: 'job_id'},
                        {data: 'id'},
                    ],
                    columnDefs: [
                    {
                        render: function (data, type, row) {
                            return '<button class="btn btn-primary btn-xs btnOpenJob" data-job-id="' + data + '"/>详细输出</button>';
                        },
                        targets: 6,
                    },
                    {
                        render: function (data, type, row) {
                            return data == '' ? ' ------ ' : data.substr(0, 7);
                        },
                        targets: 2,
                    },
                    {
                        render: function (data, type, row) {
                            var cls = {"Waiting":"label-default", "Building":"label-info", "Success":"label-success", "Error":"label-danger"};
                            return '<span class="label '+ cls[data] +'">' + data +  '</span>';
                        },
                        targets: 3
                    }
                    ]
                });
            } else {
                table.ajax.reload();
            }

            renderNewBuildForm(document.getElementById('buildFormWrapper'), {checkout: defaultBranch}, table.ajax.reload);

            $('#buildTable').unbind('draw.dt');
            $('#buildTable').on('draw.dt', function (e) {
                initJobBtn();
            });

            return table.ajax.reload;
        };
    }();

    var showHosts = function () {
        var table = null;
        return function () {
            if (table === null) {
                table = $("#hostsTable").DataTable({
                    ajax: '/api/site/' + siteId + "/host",
                    paging: false,
                    ordering: false,
                    info: false,
                    columns: [
                        {data: 'name'},
                        {data: 'ip'},
                        {data: 'port'},
                        {data: 'type'},
                        {data: 'host_type'},
                        {data: 'id'},
                        {data: 'id'},
                    ],
                    columnDefs:
                    [
                    {
                        render: function (data, type, row) {
                            return data.name;
                        },
                        targets: 4,
                    },
                    {
                        render: function (data, type, row) {
                            var clss = data == 'APP' ? 'label-success' : 'label-default';
                            return "<span class=\"label " + clss + "\">" + data + "</span>";
                        },
                        targets: 3
                    },
                    {
                        render: function (data, type, row) {
                            return "<button class=\"btn btn-warning btn-xs btnHostDelete\" data-name=\""+ row.name +"\" data-id=\"" + data + "\">删除</button>";
                        },
                        targets: 6
                    },
                    {
                        render: function (data, type, row) {
                            return "<button class=\"btn btn-primary btn-xs btnHostEdit\" data-json='" + JSON.stringify(row) + "' data-name=\""+ row.name +"\">修改</button>";
                        },
                        targets: 5
                    }
                    ]
                });
            } else {
                /*table.ajax.url('/api/site/' + siteId + "/host").load();*/
                table.ajax.reload();
            }

            $('#newHost').unbind();
            $('#newHost').click(function (data) {
                var btn = $(this);
                btn.button('loading');
                $.getJSON('/api/site/' + siteId + '/hosttype', function (data) {
                    btn.button('reset');
                    if (data.code == 0) {
                        renderSiteHosts(normalModalWrapper, 'new', {host_types: data.data}, table.ajax.reload);
                    } else {
                        alert(data.msg);
                    }
                });
            });

            $('#hostsTable').unbind('click');
            $('#hostsTable').on('click', '.btnHostEdit', function (e) {
                var btn = $(this);
                btn.button('loading');
                $.getJSON('/api/site/' + siteId + '/hosttype', function (data) {
                    btn.button('reset');
                    if (data.code == 0) {
                        var host = eval('(' + btn.attr('data-json') + ')');
                        renderSiteHosts(normalModalWrapper, 'edit', {host: host, host_types: data.data}, table.ajax.reload);
                    } else {
                        alert(data.msg);
                    }
                });
            });

            $('#hostsTable').on('click', '.btnHostDelete', function (e) {
                var btn = $(this);
                if (confirm("确定要删除主机" + btn.attr("data-name") + "吗")) {
                    btn.button('loading');
                    $.post('/api/site/' + siteId + '/host/' + btn.attr('data-id'), {
                        _token: csrfToken,
                        _method: 'DELETE',
                    }, function (data) {
                        btn.button('reset');
                        if (data.code == 0) {
                            table.ajax.reload();
                        } else {
                            alert(data.msg);
                        }
                    }, 'json');
                }
            });
        };
    }();

    var showHostType = function () {
        var table = null;
        var dataUrl = '';
        return function () {
            if (table === null) {
                table = $("#hostTypeTable").DataTable({
                    ajax: '/api/site/' + siteId + "/hosttype",
                    paging: false,
                    ordering: false,
                    info: false,
                    columns: [
                        {data: 'id'},
                        {data: 'name'},
                        {data: 'catalog'},
                        {data: 'id'},
                        {data: 'id'},
                    ],
                    columnDefs:
                    [
                        {
                            render: function (data, type, row) {
                                return data.name;
                            },
                            targets: 2,
                        },
                        {
                            render: function (data, type, row) {
                                return "<button class=\"btn btn-primary btn-xs btnHostTypeEdit\" data-json=\'" + JSON.stringify(row) + "\'>修改</button>";
                            },
                            targets: 3,
                        },
                        {
                            render: function (data, type, row) {
                                return "<button class=\"btn btn-warning btn-xs btnHostTypeDelete\" data-name=\""+ row.name +"\" data-id=\"" + data + "\">删除</button>";
                            },
                            targets: 4
                        }
                    ]
                });
            } else {
                table.ajax.reload();
            }

            $("#newHostType").unbind('click');
            $("#newHostType").click(function (e) {
                var btn = $(this);
                btn.button('loading');
                $.getJSON('/api/site/' + siteId + '/hosttypecatalog', function (data) {
                    btn.button('reset');
                    if (data.code == 0) {
                        renderSiteHostType(normalModalWrapper, 'new', {'catalogs' : data.data}, table.ajax.reload);
                    } else {
                        alert(data.msg);
                    }
                });
            });

            $('#hostTypeTable').unbind('click');
            $('#hostTypeTable').on('click', '.btnHostTypeDelete', function (e) {
                var btn = $(this);
                btn.button('loading');
                if (confirm("确定要删除 " + btn.attr('data-name') + "吗？")) {
                    $.post('/api/site/' + siteId + '/hosttype/' + btn.attr('data-id'), {
                        _token: csrfToken,
                        _method: 'DELETE'
                    }, function (data) {
                        btn.button('reset');
                        if (data.code == 0) {
                            table.ajax.reload();
                        } else {
                            alert(data.msg);
                        }
                    }, 'json');
                }
            });
            $('#hostTypeTable').on('click', '.btnHostTypeEdit', function (e) {
                var btn = $(this);
                btn.button('loading');
                $.getJSON('/api/site/' + siteId + '/hosttypecatalog', function (data) {
                    btn.button('reset');
                    if (data.code == 0) {
                        var hosttype = eval('(' + btn.attr('data-json') + ')');
                        renderSiteHostType(normalModalWrapper, 'edit', {hosttype: hosttype, 'catalogs' : data.data}, table.ajax.reload);
                    } else {
                        alert(data.msg);
                    }
                });
            });
        }
    }();

    var initBtn = function () {
        $('a[data-toggle="tab"]').unbind('shown.bs.tab');
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var prevTab = $(e.relatedTarget);
            if (prevTab.attr('href') != undefined && prevTab.attr('href').substr(0, 8) == '#JobInfo') {
                prevTab.remove();
                $(prevTab.attr('href')).remove();
            }

            if (timeoutEvent !== null) {
                timeoutEvent.clear();
                timeoutEvent = null;
            }

            if (refreshInterval !== null) {
                window.clearInterval(refreshInterval);
                refreshInterval = null;
            }

            var url = null;
            var render = null;
            var element = null
            var thisTab = $(e.target);
            location.hash = thisTab.attr('href');

            if (thisTab.attr('href').substr(0, 8) == '#JobInfo') {
                timeoutEvent = renderJobInfo(document.getElementById(thisTab.attr('href').substr(1)), thisTab.attr('data-job-id'));
                return '';
            }

            switch (thisTab.attr('href')) {
                case '#Build':
                    var callback = showBuilds();
                    refreshInterval = window.setInterval(callback, 5000);
                    return ;
                case "#Setting":
                    url = '/api/site/' + siteId + '/configure';
                    render = renderSiteConfig;
                    element = document.getElementById('Setting');
                    break;
                case "#DeploySetting":
                    url = '/api/site/' + siteId + '/deploy_configure';
                    render = renderSiteDeployConfig;
                    element = document.getElementById('DeploySetting');
                    break;
                case '#HostType':
                    showHostType();
                    return ;
                case '#Hosts':
                    showHosts();
                    return ;
            }
            if (url !== null) {
                $(element).html("<div>&nbsp;&nbsp;&nbsp;<img src='/static/ajax-loader.gif' /></div>");
                $.getJSON(url, function (data) {
                    if (data.code == 0) {
                        render(element, data.data);
                    } else {
                        alert(data.msg);
                    }
                });
            }
        });
    };

    window.onhashchange = function () {
        if (location.hash.substr(0, 8) == '#JobInfo') {
            var tab = $('#myTab a:last');
            var href = tab.attr('href');
            if (href.substr(0, 8) == '#JobInfo') {
                if (href != location.hash) {
                    $(href).remove();
                    tab.remove();
                } else {
                    $('#myTab a[href="' + location.hash + '"]').tab("show");
                    return ;
                }
            }
            showJobInfo(location.hash.substr(9));
        } else {
            $('#myTab a[href="' + location.hash + '"]').tab("show");
        }
    };

    initBtn();

    if (location.hash == '') {
        location.hash = '#Build';
    } else if (location.hash.substr(0, 8) == '#JobInfo') {
        showJobInfo(location.hash.substr(9));
    } else {
            $('#myTab a[href="' + location.hash + '"]').tab("show");
    }

    /*$('#myTab a[href="#Build"]').tab("show");*/
});




</script>
{% endblock footer_js %}
